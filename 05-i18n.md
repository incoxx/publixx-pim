# Publixx PIM â€” Ãœbersetzungsarchitektur (i18n)

> **Zweck:** Mehrsprachigkeit auf allen Ebenen. Verwende diesen Skill bei allem, was mit Sprachen, Ãœbersetzungen, Fallbacks und mehrsprachigen APIs zu tun hat.

---

## Prinzip

Alles KANN Ã¼bersetzbar sein, aber nichts MUSS. Ein Textfeld "Norm" ist einsprachig. Ein Produktname ist mehrsprachig. Das Attribut steuert per `is_translatable`, ob Werte Ãœbersetzung benÃ¶tigen.

---

## Drei Ebenen

### Ebene 1: System-Labels

Attributnamen, Typnamen, Hierarchienamen, Sichtnamen, etc.

**Speicherung:** Feste Spalten `name_de`, `name_en` + JSON-Spalte `name_json` fÃ¼r weitere Sprachen.

```sql
-- Beispiel: attributes
name_de = 'Gewicht'
name_en = 'Weight'
name_json = '{"fr": "Poids", "es": "Peso", "zh": "é‡é‡"}'
```

**Betroffene EntitÃ¤ten:** attributes, attribute_types, unit_groups, value_lists, attribute_views, hierarchies, hierarchy_nodes, product_types, price_types, product_relation_types

**Warum feste Spalten + JSON?**
- de/en als feste Spalten â†’ schnelle Queries, kein JSON_EXTRACT nÃ¶tig
- Weitere Sprachen in JSON â†’ flexibel erweiterbar ohne Schema-Migration

### Ebene 2: Stammdaten

Wertelisten-EintrÃ¤ge und Einheiten-KÃ¼rzel.

```sql
-- value_list_entries
display_value_de = 'Rot'
display_value_en = 'Red'
display_value_json = '{"fr": "Rouge", "es": "Rojo"}'

-- units (nur wenn is_translatable = true)
abbreviation = 'Stk.'        -- Default/Deutsch
abbreviation_json = '{"en": "pcs.", "fr": "pce."}'
```

Einheiten wie `kg`, `mm`, `m` sind international â†’ `is_translatable = false`.
Einheiten wie `Stk.`, `Bl.` brauchen Ãœbersetzung â†’ `is_translatable = true`.

### Ebene 3: Produktdaten (Attributwerte)

Die kritische Ebene. Gesteuert Ã¼ber `attributes.is_translatable`.

```
Attribut: Produktname   â†’ is_translatable = true  â†’ Pro Sprache ein Wert
Attribut: Gewicht       â†’ is_translatable = false â†’ Ein Wert, sprachunabhÃ¤ngig
Attribut: Norm          â†’ is_translatable = false â†’ Ein Wert, Fachterm
Attribut: Farbe (Sel.)  â†’ is_translatable = false â†’ Key gespeichert, Anzeige aus Werteliste
```

**Tabelle product_attribute_values:**

| product_id | attribute_id | language | value_string |
|-----------|-------------|---------|-------------|
| prod-001 | attr-name | de | Akkubohrschrauber ProDrill |
| prod-001 | attr-name | en | Cordless Drill ProDrill |
| prod-001 | attr-name | fr | Perceuse sans fil ProDrill |
| prod-001 | attr-weight | NULL | *(value_number = 1.8)* |
| prod-001 | attr-norm | NULL | DIN EN 60745-1 |
| prod-001 | attr-color | NULL | red *(Key, Anzeige aus Werteliste)* |

**Regel:** `language = NULL` bei nicht-Ã¼bersetzten Attributen. `language = 'de'/'en'/...` bei Ã¼bersetzten.

**Unique Constraint:**
```sql
UNIQUE (product_id, attribute_id, language, multiplied_index)
```

---

## API: Sprachsteuerung

### Header oder Parameter

```
Accept-Language: de              â†’ Deutsch
?lang=en                         â†’ Englisch
?lang=de,en                      â†’ Beide Sprachen
?lang=fr                         â†’ FranzÃ¶sisch (mit Fallback)
```

### Fallback-Kette

```
Angeforderte Sprache â†’ en â†’ de â†’ erster verfÃ¼gbarer Wert
```

Wenn `?lang=fr` und kein FR-Wert existiert: Versuche EN, dann DE, dann was da ist.

### Response-Format

**Einsprachig (`?lang=de`):**
```json
{
  "productName": "Akkubohrschrauber ProDrill 18V",
  "weight": 1.8,
  "norm": "DIN EN 60745-1"
}
```

**Mehrsprachig (`?lang=de,en`):**
```json
{
  "productName": "Akkubohrschrauber ProDrill 18V",
  "productName_en": "Cordless Drill ProDrill 18V",
  "weight": 1.8,
  "norm": "DIN EN 60745-1"
}
```

Nicht-Ã¼bersetzte Felder (weight, norm) erscheinen nur einmal. Ãœbersetzte Felder erhalten `_{lang}`-Suffix fÃ¼r jede Zusatzsprache.

---

## Attributwerte speichern (API)

```json
PUT /api/v1/products/{id}/attribute-values
{
  "values": [
    { "attribute_id": "uuid-name", "value": "Akkubohrschrauber", "language": "de" },
    { "attribute_id": "uuid-name", "value": "Cordless Drill", "language": "en" },
    { "attribute_id": "uuid-weight", "value": 1.8 },
    { "attribute_id": "uuid-norm", "value": "DIN EN 60745-1" }
  ]
}
```

Das Backend prÃ¼ft: Wenn `attributes.is_translatable = false` und `language` mitgesendet wird â†’ 422 Error. Wenn `is_translatable = true` und kein `language` â†’ 422 Error.

---

## Laravel: Hilfsfunktionen

```php
// SprachauflÃ¶sung fÃ¼r System-Labels
function getLocalizedName(Model $entity, string $lang): string {
    if ($lang === 'de') return $entity->name_de;
    if ($lang === 'en') return $entity->name_en ?? $entity->name_de;
    // Weitere Sprachen aus JSON
    $json = $entity->name_json ?? [];
    return $json[$lang] ?? $entity->name_en ?? $entity->name_de;
}

// Attributwerte mit Sprache laden
Product::with(['attributeValues' => function ($query) use ($lang) {
    $query->where(function ($q) use ($lang) {
        $q->whereNull('language')                    // SprachunabhÃ¤ngig
          ->orWhere('language', $lang);               // GewÃ¼nschte Sprache
    });
}]);
```

---

## UI: Ãœbersetzungsworkflow

| Element | Beschreibung |
|---------|--------------|
| Sprach-Switcher (global) | Dropdown oben rechts: DE / EN / FR â€” Ã¤ndert gesamte Ansicht |
| Sprach-Tabs (pro Feld) | Ãœbersetzte Felder zeigen Tabs mit Flaggen-Icons |
| Ãœbersetzungs-Fortschritt | Badge: "EN: 78% Ã¼bersetzt" auf Produktebene |
| Fehlende Ãœbersetzungen | Filter: "Produkte mit fehlender EN-Ãœbersetzung" |
| Bulk-Export | Multi-Select â†’ CSV mit Quell+Zielsprache fÃ¼r Ãœbersetzer |
| Copy-from-Language | Button: "Von DE nach EN kopieren" fÃ¼r InitialfÃ¼llung |
| Sprach-Flag am Feld | Dezentes Icon an Ã¼bersetzten Feldern |

---

## Sprachen konfigurieren

VerfÃ¼gbare Sprachen werden in der System-Config definiert:

```php
// config/pim.php
'languages' => [
    'de' => ['name' => 'Deutsch', 'flag' => 'ğŸ‡©ğŸ‡ª', 'is_default' => true],
    'en' => ['name' => 'English', 'flag' => 'ğŸ‡¬ğŸ‡§', 'is_default' => false],
    'fr' => ['name' => 'FranÃ§ais', 'flag' => 'ğŸ‡«ğŸ‡·', 'is_default' => false],
],
'fallback_chain' => ['en', 'de'],
```
